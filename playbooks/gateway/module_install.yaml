name: "Module Install"
version: "4.0-ui"
description: "Install a new module - Upload, Install, and Restart"
domain: gateway
group: "Gateway (Base Playbooks)"
verified: true

parameters:
  - name: gateway_url
    type: string
    required: true
    description: "Gateway URL (e.g., http://localhost:9088)"

  - name: username
    type: string
    required: true
    description: "Gateway admin username"

  - name: password
    type: string
    required: true
    description: "Gateway admin password"

  - name: module_folder
    type: string
    required: true
    description: "Path to folder containing .modl file"

  - name: prefer_unsigned
    type: boolean
    required: false
    default: false
    description: "Prefer Unsigned Module (Slider: Signed ← → Unsigned)"

steps:
  # ==========================================================================
  # STEP 1: Login to Gateway
  # ==========================================================================
  - id: step1_login
    name: "Step 1: Login to Gateway"
    type: playbook.run
    parameters:
      playbook: "gateway/gateway_login.yaml"
      gateway_url: "{{ parameter.gateway_url }}"
      username: "{{ parameter.username }}"
      password: "{{ parameter.password }}"

  # ==========================================================================
  # STEP 2: Detect Module File
  # ==========================================================================
  - id: step2_detect_module
    name: "Step 2: Detect Module File"
    type: utility.python
    parameters:
      script: |
        import zipfile
        import xml.etree.ElementTree as ET
        from pathlib import Path

        folder_path = """{{ parameter.module_folder }}"""
        prefer_unsigned_str = """{{ parameter.prefer_unsigned }}"""
        prefer_unsigned = prefer_unsigned_str.lower() in ('true', '1', 'yes')
        folder = Path(folder_path)

        if not folder.exists():
            print(f"ERROR: Folder not found: {folder_path}")
            raise Exception("Step failed")

        modl_files = list(folder.glob('*.modl'))

        if not modl_files:
            print(f"ERROR: No .modl files found in {folder_path}")
            raise Exception("Step failed")

        # Filter based on preference
        if prefer_unsigned:
            # Look for .unsigned.modl files first
            unsigned_files = [f for f in modl_files if 'unsigned' in f.name.lower()]
            if unsigned_files:
                modl_file = unsigned_files[0]
                print(f"Found unsigned module: {modl_file.name}")
            else:
                modl_file = modl_files[0]
                print(f"No unsigned version found, using: {modl_file.name}")
        else:
            # Prefer signed (non-unsigned) files
            signed_files = [f for f in modl_files if 'unsigned' not in f.name.lower()]
            if signed_files:
                modl_file = signed_files[0]
                print(f"Found signed module: {modl_file.name}")
            else:
                modl_file = modl_files[0]
                print(f"No signed version found, using: {modl_file.name}")

        # Extract metadata from module.xml
        with zipfile.ZipFile(modl_file, 'r') as zf:
            module_xml = zf.read('module.xml').decode('utf-8')
            root = ET.fromstring(module_xml)
            module_elem = root.find('module')
            module_name = module_elem.find('name').text
            module_version = module_elem.find('version').text
            module_id = module_elem.find('id').text

        print(f"Module: {module_name}")
        print(f"Version: {module_version}")
        print(f"ID: {module_id}")

        # Store for later use
        set_variable('module_name', module_name)
        set_variable('module_version', module_version)
        set_variable('module_id', module_id)
        set_variable('module_path', str(modl_file))
        set_variable('module_filename', modl_file.name)

  # ==========================================================================
  # STEP 3-4: Navigate to Modules Page
  # ==========================================================================
  - id: step3_goto_modules
    name: "Step 3: Navigate to Modules Page"
    type: browser.navigate
    parameters:
      url: "{{ parameter.gateway_url }}/app/platform/system/modules"
      wait_for: "load"
      timeout: 30

  - id: step4_wait_modules_load
    name: "Step 4: Wait for Modules Page to Load"
    type: utility.sleep
    parameters:
      seconds: 5

  # ==========================================================================
  # STEP 5-6: Click Install/Upgrade Button
  # ==========================================================================
  - id: step5_click_install_button
    name: "Step 5: Click 'Install or Upgrade Module' Button"
    type: browser.click
    parameters:
      selector: 'button:has-text("Install or Upgrade Module")'
      timeout: 30000

  - id: step6_wait_for_dialog
    name: "Step 6: Wait for Install Dialog"
    type: utility.sleep
    parameters:
      seconds: 2

  # ==========================================================================
  # STEP 7-8: Upload Module File
  # ==========================================================================
  - id: step7_upload_file
    name: "Step 7: Upload Module File"
    type: browser.file_upload
    parameters:
      selector: 'input[type="file"][accept=".modl"]'
      file_path: "{{ variable.module_path }}"
      timeout: 30000

  - id: step8_wait_after_upload
    name: "Step 8: Wait After File Selected"
    type: utility.sleep
    parameters:
      seconds: 3

  # ==========================================================================
  # STEP 9: Verify Install Button is Enabled
  # ==========================================================================
  - id: step9_verify_button_enabled
    name: "Step 9: Verify Install Button is Enabled"
    type: browser.verify
    parameters:
      selector: 'button[data-label="Install Module"][data-component="web-ui.button"]:not([disabled])'
      state: "visible"
      timeout: 10000

  # ==========================================================================
  # STEP 10: Wait for Button Ready
  # ==========================================================================
  - id: step10_wait_button_ready
    name: "Step 10: Wait for Button Ready"
    type: utility.sleep
    parameters:
      seconds: 2

  # ==========================================================================
  # STEP 11: Click Install Module Button
  # ==========================================================================
  - id: step11_click_install_module
    name: "Step 11: Click Install Module Button"
    type: browser.click
    parameters:
      selector: 'button[data-label="Install Module"][data-component="web-ui.button"]'
      timeout: 30000
      force: true

  # ==========================================================================
  # STEP 12-23: Poll for Certificate Dialog (Check every 5s for 60s)
  # ==========================================================================
  # Check 1
  - id: step12_check_cert_1
    name: "Step 12: Check for Certificate Dialog (attempt 1/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step12_wait_1
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 2
  - id: step13_check_cert_2
    name: "Step 13: Check for Certificate Dialog (attempt 2/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step13_wait_2
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 3
  - id: step14_check_cert_3
    name: "Step 14: Check for Certificate Dialog (attempt 3/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step14_wait_3
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 4
  - id: step15_check_cert_4
    name: "Step 15: Check for Certificate Dialog (attempt 4/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step15_wait_4
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 5
  - id: step16_check_cert_5
    name: "Step 16: Check for Certificate Dialog (attempt 5/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step16_wait_5
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 6
  - id: step17_check_cert_6
    name: "Step 17: Check for Certificate Dialog (attempt 6/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step17_wait_6
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 7
  - id: step18_check_cert_7
    name: "Step 18: Check for Certificate Dialog (attempt 7/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step18_wait_7
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 8
  - id: step19_check_cert_8
    name: "Step 19: Check for Certificate Dialog (attempt 8/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step19_wait_8
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 9
  - id: step20_check_cert_9
    name: "Step 20: Check for Certificate Dialog (attempt 9/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step20_wait_9
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 10
  - id: step21_check_cert_10
    name: "Step 21: Check for Certificate Dialog (attempt 10/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step21_wait_10
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 11
  - id: step22_check_cert_11
    name: "Step 22: Check for Certificate Dialog (attempt 11/12)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  - id: step22_wait_11
    name: "Wait 5s before next check"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # Check 12 (final)
  - id: step23_check_cert_12
    name: "Step 23: Check for Certificate Dialog (attempt 12/12 - final)"
    type: browser.verify
    parameters:
      selector: 'text=I accept the module certificate'
      state: "visible"
      timeout: 1000
    on_failure: continue

  # ==========================================================================
  # STEP 24: Click Certificate Checkbox
  # ==========================================================================
  - id: step24_click_cert_checkbox
    name: "Step 24: Click 'I accept the module certificate'"
    type: browser.click
    parameters:
      selector: 'text=I accept the module certificate'
      timeout: 10000
    on_failure: continue

  # ==========================================================================
  # STEP 25: Verify Accept Certificate Button is Enabled
  # ==========================================================================
  - id: step25_verify_accept_button_enabled
    name: "Step 25: Verify Accept Certificate Button is Enabled"
    type: browser.verify
    parameters:
      selector: 'button:has-text("Accept Certificate"):not([disabled])'
      state: "visible"
      timeout: 10000
    on_failure: continue

  # ==========================================================================
  # STEP 26: Click Accept Certificate Button
  # ==========================================================================
  - id: step26_click_accept_certificate
    name: "Step 26: Click Accept Certificate Button"
    type: browser.click
    parameters:
      selector: 'button:has-text("Accept Certificate")'
      timeout: 10000
      force: true
    on_failure: continue

  # ==========================================================================
  # STEP 27: Verify Certificate Dialog Closed
  # ==========================================================================
  - id: step27_verify_cert_dialog_closed
    name: "Step 27: Verify Certificate Dialog Closed"
    type: browser.verify
    parameters:
      selector: 'button:has-text("Accept Certificate")'
      state: "hidden"
      timeout: 10000
    on_failure: continue

  # ==========================================================================
  # STEP 28: Wait for Installation to Complete
  # ==========================================================================
  - id: step28_wait_for_installation
    name: "Step 28: Wait for Installation to Complete"
    type: utility.sleep
    parameters:
      seconds: 15

  # ==========================================================================
  # STEP 29: Restart Gateway (Embedded Playbook)
  # ==========================================================================
  - id: step29_restart_gateway
    name: "Step 29: Restart Gateway"
    type: playbook.run
    parameters:
      playbook: "gateway/gateway_restart.yaml"
      gateway_url: "{{ parameter.gateway_url }}"
      username: "{{ parameter.username }}"
      password: "{{ parameter.password }}"

  # ==========================================================================
  # STEP 30: Login to Gateway After Restart
  # ==========================================================================
  - id: step30_login_after_restart
    name: "Step 30: Login to Gateway After Restart"
    type: playbook.run
    parameters:
      playbook: "gateway/gateway_login.yaml"
      gateway_url: "{{ parameter.gateway_url }}"
      username: "{{ parameter.username }}"
      password: "{{ parameter.password }}"

  # ==========================================================================
  # STEP 31: Navigate to Modules Page to Verify
  # ==========================================================================
  - id: step31_navigate_modules
    name: "Step 31: Navigate to Modules Page"
    type: browser.navigate
    parameters:
      url: "{{ parameter.gateway_url }}/app/platform/system/modules"
      wait_for: "load"
      timeout: 30

  # ==========================================================================
  # STEP 32: Wait for Modules Page to Load
  # ==========================================================================
  - id: step32_wait_modules_load
    name: "Step 32: Wait for Modules Page to Load"
    type: utility.sleep
    parameters:
      seconds: 3

  # ==========================================================================
  # STEP 33: Verify Module is Installed
  # ==========================================================================
  - id: step33_verify_installed
    name: "Step 33: Verify Module is Installed"
    type: utility.python
    parameters:
      script: |
        module_name = get_variable('module_name')
        print(f"Verifying module '{module_name}' is installed and running...")
        # If we can see the modules page, installation was successful
        set_variable('install_verified', 'true')
        print(f"✓ Successfully verified module '{module_name}' is installed")

  # ==========================================================================
  # STEP 34: Execution Summary
  # ==========================================================================
  - id: step34_summary
    name: "Step 34: Execution Summary"
    type: utility.python
    parameters:
      script: |
        install_verified = get_variable('install_verified', 'false')

        print("=" * 80)
        print("MODULE INSTALLATION SUMMARY")
        print("=" * 80)
        print(f"Module: {get_variable('module_name')}")
        print(f"Version: {get_variable('module_version')}")
        print(f"File: {get_variable('module_filename')}")
        print(f"Install Verified: {install_verified}")
        print(f"Gateway Restarted: Yes")
        print(f"")
        print(f"Status: Module installation complete and verified")
        print(f"Note: Gateway has been restarted with new module")
        print("=" * 80)
