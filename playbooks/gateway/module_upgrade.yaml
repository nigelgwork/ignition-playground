name: "Module Upgrade"
version: "4.0-ui"
description: "Upgrade an existing module - Uninstall old version then install new version"
domain: gateway
verified: true

parameters:
  - name: gateway_url
    type: string
    required: true
    description: "Gateway URL (e.g., http://localhost:9088)"

  - name: username
    type: string
    required: true
    description: "Gateway admin username"

  - name: password
    type: string
    required: true
    description: "Gateway admin password"

  - name: module_folder
    type: string
    required: true
    description: "Path to folder containing .modl file"

  - name: prefer_unsigned
    type: boolean
    required: false
    default: false
    description: "Prefer Unsigned Module (Slider: Signed ← → Unsigned)"

steps:
  # ==========================================================================
  # STEP 1: Detect Module File and Metadata
  # ==========================================================================
  - id: step1_detect_module
    name: "Step 1: Detect Module File and Metadata"
    type: utility.python
    parameters:
      script: |
        import zipfile
        import xml.etree.ElementTree as ET
        from pathlib import Path

        folder_path = """{{ parameter.module_folder }}"""
        prefer_unsigned_str = """{{ parameter.prefer_unsigned }}"""
        prefer_unsigned = prefer_unsigned_str.lower() in ('true', '1', 'yes')
        folder = Path(folder_path)

        if not folder.exists():
            print(f"ERROR: Folder not found: {folder_path}")
            raise Exception("Step failed")

        modl_files = list(folder.glob('*.modl'))

        if not modl_files:
            print(f"ERROR: No .modl files found in {folder_path}")
            raise Exception("Step failed")

        # Filter based on preference
        if prefer_unsigned:
            # Look for .unsigned.modl files first
            unsigned_files = [f for f in modl_files if 'unsigned' in f.name.lower()]
            if unsigned_files:
                modl_file = unsigned_files[0]
                print(f"Found unsigned module: {modl_file.name}")
            else:
                modl_file = modl_files[0]
                print(f"No unsigned version found, using: {modl_file.name}")
        else:
            # Prefer signed (non-unsigned) files
            signed_files = [f for f in modl_files if 'unsigned' not in f.name.lower()]
            if signed_files:
                modl_file = signed_files[0]
                print(f"Found signed module: {modl_file.name}")
            else:
                modl_file = modl_files[0]
                print(f"No signed version found, using: {modl_file.name}")

        # Extract metadata from module.xml
        with zipfile.ZipFile(modl_file, 'r') as zf:
            module_xml = zf.read('module.xml').decode('utf-8')
            root = ET.fromstring(module_xml)
            module_elem = root.find('module')
            module_name = module_elem.find('name').text
            module_version = module_elem.find('version').text
            module_id = module_elem.find('id').text

        print(f"Module to upgrade: {module_name}")
        print(f"Version: {module_version}")
        print(f"ID: {module_id}")
        print(f"File: {modl_file.name}")

        # Store for later use
        set_variable('module_name', module_name)
        set_variable('module_version', module_version)
        set_variable('module_id', module_id)
        set_variable('module_path', str(modl_file))
        set_variable('module_filename', modl_file.name)

  # ==========================================================================
  # STEP 2: Uninstall Existing Module
  # ==========================================================================
  - id: step2_uninstall
    name: "Step 2: Uninstall Existing Module"
    type: playbook.run
    parameters:
      playbook: "gateway/module_uninstall.yaml"
      gateway_url: "{{ parameter.gateway_url }}"
      username: "{{ parameter.username }}"
      password: "{{ parameter.password }}"
      module_name: "{{ variable.module_name }}"

  # ==========================================================================
  # STEP 3: Install New Module Version
  # ==========================================================================
  - id: step3_install
    name: "Step 3: Install New Module Version"
    type: playbook.run
    parameters:
      playbook: "gateway/module_install.yaml"
      gateway_url: "{{ parameter.gateway_url }}"
      username: "{{ parameter.username }}"
      password: "{{ parameter.password }}"
      module_folder: "{{ parameter.module_folder }}"
      prefer_unsigned: "{{ parameter.prefer_unsigned }}"

  # ==========================================================================
  # STEP 4: Summary Report
  # ==========================================================================
  - id: step4_summary
    name: "Step 4: Upgrade Summary"
    type: utility.python
    parameters:
      script: |
        print("=" * 80)
        print("MODULE UPGRADE COMPLETE")
        print("=" * 80)
        print("Old version has been uninstalled")
        print("New version has been installed")
        print("Gateway has been restarted twice (after uninstall and after install)")
        print("=" * 80)
