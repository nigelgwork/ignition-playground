name: "Module Uninstall"
version: "4.0-ui"
description: "Uninstall an existing module"
domain: gateway

parameters:
  - name: gateway_url
    type: string
    required: true
    description: "Gateway URL (e.g., http://localhost:9088)"

  - name: username
    type: string
    required: true
    description: "Gateway admin username"

  - name: password
    type: string
    required: true
    description: "Gateway admin password"

  - name: module_name
    type: string
    required: true
    description: "Module name to uninstall (e.g., Perspective)"

steps:
  # ==========================================================================
  # STEP 1: Login to Gateway
  # ==========================================================================
  - id: step1_login
    name: "Step 1: Login to Gateway"
    type: playbook.run
    parameters:
      playbook: "gateway/gateway_login.yaml"
      gateway_url: "{{ parameter.gateway_url }}"
      username: "{{ parameter.username }}"
      password: "{{ parameter.password }}"

  # ==========================================================================
  # STEP 2: Navigate to Modules Page
  # ==========================================================================
  - id: step2_goto_modules
    name: "Step 2: Navigate to Modules Page"
    type: browser.navigate
    parameters:
      url: "{{ parameter.gateway_url }}/app/platform/system/modules"
      wait_for: "load"
      timeout: 30

  - id: step3_wait_modules_load
    name: "Step 3: Wait for Modules Page to Load"
    type: utility.sleep
    parameters:
      seconds: 3

  # ==========================================================================
  # STEP 4: Get First Word of Module Name
  # ==========================================================================
  - id: step4_get_first_word
    name: "Step 4: Get First Word of Module Name"
    type: utility.python
    parameters:
      script: |
        module_name = """{{ parameter.module_name }}"""
        first_word = module_name.split(' ')[0]
        set_variable('module_name_first_word', first_word)

  # ==========================================================================
  # STEP 5: Search for Module
  # ==========================================================================
  - id: step5_search_module
    name: "Step 5: Search for Module"
    type: browser.fill
    parameters:
      selector: 'input[placeholder*="Filter"]'
      value: "{{ variable.module_name_first_word }}"
      timeout: 10000

  - id: step6_wait_for_search
    name: "Step 6: Wait for Search Results"
    type: utility.sleep
    parameters:
      seconds: 3

  # ==========================================================================
  # STEP 7: Click More Options
  # ==========================================================================
  - id: step7_click_more_options
    name: "Step 7: Click More Options for Module"
    type: browser.click
    parameters:
      selector: 'button[aria-label*="more"]'
      timeout: 10000

  # ==========================================================================
  # STEP 8: Click Uninstall Menu Item
  # ==========================================================================
  - id: step8_click_uninstall_menu_item
    name: "Step 8: Click Uninstall Menu Item"
    type: browser.click
    parameters:
      selector: 'li:has-text("Uninstall")'
      timeout: 10000

  # ==========================================================================
  # STEP 9: Wait for Uninstall Dialog
  # ==========================================================================
  - id: step9_wait_for_dialog
    name: "Step 9: Wait for Uninstall Dialog"
    type: utility.sleep
    parameters:
      seconds: 2

  # ==========================================================================
  # STEP 10: Click Uninstall Button in Dialog
  # ==========================================================================
  - id: step10_click_uninstall_button
    name: "Step 10: Click Uninstall Button in Dialog"
    type: browser.click
    parameters:
      selector: 'button:has-text("Uninstall")'
      timeout: 10000

  # ==========================================================================
  # STEP 11: Wait for Confirmation Checkbox to Appear
  # ==========================================================================
  - id: step11_wait_for_checkbox
    name: "Step 11: Wait for Confirmation Checkbox to Appear"
    type: browser.wait
    parameters:
      selector: 'div[role="dialog"] input[type="checkbox"]'
      timeout: 10000

  # ==========================================================================
  # STEP 12: Check Confirmation Box
  # ==========================================================================
  - id: step12_check_confirm_box
    name: "Step 12: Check Confirmation Box"
    type: browser.click
    parameters:
      selector: 'div[role="dialog"] input[type="checkbox"]'
      timeout: 10000
      force: true

  # ==========================================================================
  # STEP 13: Click Final Confirm Button
  # ==========================================================================
  - id: step13_click_final_confirm
    name: "Step 13: Click Final Confirm Button"
    type: browser.click
    parameters:
      selector: 'div[role="dialog"] >> button:has-text("Uninstall"), div[role="dialog"] >> button:has-text("Confirm")'
      timeout: 10000

  # ==========================================================================
  # STEP 14: Wait After Uninstall
  # ==========================================================================
  - id: step14_wait_after_uninstall
    name: "Step 14: Wait After Uninstall"
    type: utility.sleep
    parameters:
      seconds: 3

  # ==========================================================================
  # STEP 15: Navigate to Status Page for Restart
  # ==========================================================================
  - id: step15_goto_status_for_restart
    name: "Step 15: Navigate to Status Page for Restart"
    type: browser.navigate
    parameters:
      url: "{{ parameter.gateway_url }}/app/platform/system/status"
      wait_for: "load"
      timeout: 30

  # ==========================================================================
  # STEP 16: Wait for Status Page
  # ==========================================================================
  - id: step16_wait_status_page
    name: "Step 16: Wait for Status Page"
    type: utility.sleep
    parameters:
      seconds: 3

  # ==========================================================================
  # STEP 17: Click Restart Gateway
  # ==========================================================================
  - id: step17_click_restart_after_uninstall
    name: "Step 17: Click Restart Gateway"
    type: browser.click
    parameters:
      selector: 'button:has-text("Restart"), button:has-text("Restart Gateway")'
      timeout: 10000

  # ==========================================================================
  # STEP 18: Wait for Gateway Restart
  # ==========================================================================
  - id: step18_wait_for_restart
    name: "Step 18: Wait for Gateway Restart (60 seconds)"
    type: utility.sleep
    parameters:
      seconds: 60

  # ==========================================================================
  # STEP 19: Check if Gateway is Online
  # ==========================================================================
  - id: step19_check_gateway_online
    name: "Step 19: Check if Gateway is Online"
    type: browser.navigate
    parameters:
      url: "{{ parameter.gateway_url }}"
      wait_for: "load"
      timeout: 30
    on_failure: continue

  # ==========================================================================
  # STEP 20: Wait After Restart
  # ==========================================================================
  - id: step20_wait_after_restart
    name: "Step 20: Wait After Restart"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # ==========================================================================
  # STEP 21: Execution Summary
  # ==========================================================================
  - id: step21_summary
    name: "Step 21: Execution Summary"
    type: utility.python
    parameters:
      script: |
        module_name = """{{ parameter.module_name }}"""
        print("=" * 80)
        print("MODULE UNINSTALLATION SUMMARY")
        print("=" * 80)
        print(f"Module: {module_name}")
        print(f"")
        print(f"Status: Module uninstallation complete")
        print(f"Note: Gateway has been restarted")
        print("=" * 80)
