name: "Module Uninstall"
version: "4.0-ui"
description: "Uninstall an existing module"
domain: gateway

parameters:
  - name: gateway_url
    type: string
    required: true
    description: "Gateway URL (e.g., http://localhost:9088)"

  - name: username
    type: string
    required: true
    description: "Gateway admin username"

  - name: password
    type: string
    required: true
    description: "Gateway admin password"

  - name: module_name
    type: string
    required: true
    description: "Module name to uninstall (e.g., Perspective)"

steps:
  # ==========================================================================
  # STEP 1: Login to Gateway
  # ==========================================================================
  - id: step1_login
    name: "Step 1: Login to Gateway"
    type: playbook.run
    parameters:
      playbook: "gateway/gateway_login.yaml"
      gateway_url: "{{ parameter.gateway_url }}"
      username: "{{ parameter.username }}"
      password: "{{ parameter.password }}"

  # ==========================================================================
  # STEP 2: Navigate to Modules Page
  # ==========================================================================
  - id: step2_goto_modules
    name: "Step 2: Navigate to Modules Page"
    type: browser.navigate
    parameters:
      url: "{{ parameter.gateway_url }}/app/platform/system/modules"
      wait_for: "load"
      timeout: 30

  - id: step3_wait_modules_load
    name: "Step 3: Wait for Modules Page to Load"
    type: utility.sleep
    parameters:
      seconds: 3

  # ==========================================================================
  # STEP 4: Get First Word of Module Name
  # ==========================================================================
  - id: step4_get_first_word
    name: "Step 4: Get First Word of Module Name"
    type: utility.python
    parameters:
      script: |
        module_name = """{{ parameter.module_name }}"""
        first_word = module_name.split(' ')[0]
        set_variable('module_name_first_word', first_word)

  # ==========================================================================
  # STEP 5: Search for Module
  # ==========================================================================
  - id: step5_search_module
    name: "Step 5: Search for Module"
    type: browser.fill
    parameters:
      selector: 'input[placeholder*="Filter"]'
      value: "{{ variable.module_name_first_word }}"
      timeout: 10000

  - id: step6_wait_for_search
    name: "Step 6: Wait for Search Results"
    type: utility.sleep
    parameters:
      seconds: 3

  # ==========================================================================
  # STEP 7: Click More Options
  # ==========================================================================
  - id: step7_click_more_options
    name: "Step 7: Click More Options for Module"
    type: browser.click
    parameters:
      selector: 'button[aria-label*="more"]'
      timeout: 10000

  # ==========================================================================
  # STEP 8: Click Uninstall Menu Item
  # ==========================================================================
  - id: step8_click_uninstall_menu_item
    name: "Step 8: Click Uninstall Menu Item"
    type: browser.click
    parameters:
      selector: 'li:has-text("Uninstall")'
      timeout: 10000

  # ==========================================================================
  # STEP 9: Wait for Uninstall Dialog
  # ==========================================================================
  - id: step9_wait_for_dialog
    name: "Step 9: Wait for Uninstall Dialog"
    type: utility.sleep
    parameters:
      seconds: 2

  # ==========================================================================
  # STEP 10: Click Uninstall Button in Dialog
  # ==========================================================================
  - id: step10_click_uninstall_button
    name: "Step 10: Click Uninstall Button in Dialog"
    type: browser.click
    parameters:
      selector: 'button:has-text("Uninstall")'
      timeout: 10000

  # ==========================================================================
  # STEP 11: Click Restart Gateway (Bottom Right Corner)
  # ==========================================================================
  - id: step11_click_restart_gateway
    name: "Step 11: Click Restart Gateway"
    type: browser.click
    parameters:
      selector: 'button:has-text("Restart Gateway"), button:has-text("Restart")'
      timeout: 10000

  # ==========================================================================
  # STEP 12: Wait for Confirmation Dialog
  # ==========================================================================
  - id: step12_wait_for_confirmation
    name: "Step 12: Wait for Confirmation Dialog"
    type: utility.sleep
    parameters:
      seconds: 3

  # ==========================================================================
  # STEP 13: Screenshot - Capture Confirmation Dialog
  # ==========================================================================
  - id: step13_screenshot_dialog
    name: "Step 13: Screenshot - Confirmation Dialog"
    type: browser.screenshot
    parameters:
      name: "restart_confirmation_dialog"
      full_page: false

  # ==========================================================================
  # STEP 14: Try Multiple Checkbox Selectors
  # ==========================================================================
  - id: step14_click_checkbox_span
    name: "Step 14: Click Checkbox (try span wrapper)"
    type: browser.click
    parameters:
      selector: 'span:has(input[type="checkbox"]), input[type="checkbox"] + span, label span'
      timeout: 10000
      force: true
    on_failure: continue

  # ==========================================================================
  # STEP 15: Alternative - Click Checkbox Input Directly
  # ==========================================================================
  - id: step15_click_checkbox_input
    name: "Step 15: Click Checkbox (try input directly)"
    type: browser.click
    parameters:
      selector: 'input[type="checkbox"]'
      timeout: 10000
      force: true
    on_failure: continue

  # ==========================================================================
  # STEP 16: Alternative - Click Any Label
  # ==========================================================================
  - id: step16_click_checkbox_label
    name: "Step 16: Click Checkbox (try label)"
    type: browser.click
    parameters:
      selector: 'label, label span, div[role="dialog"] label'
      timeout: 10000
      force: true
    on_failure: continue

  # ==========================================================================
  # STEP 17: Screenshot After Checkbox Attempts
  # ==========================================================================
  - id: step17_screenshot_after_checkbox
    name: "Step 17: Screenshot - After Checkbox Attempts"
    type: browser.screenshot
    parameters:
      name: "after_checkbox_clicks"
      full_page: false

  # ==========================================================================
  # STEP 18: Wait for Confirm Button to Enable
  # ==========================================================================
  - id: step18_wait_for_confirm_enable
    name: "Step 18: Wait for Confirm Button to Enable"
    type: utility.sleep
    parameters:
      seconds: 2

  # ==========================================================================
  # STEP 19: Click Confirm Button
  # ==========================================================================
  - id: step19_click_confirm
    name: "Step 19: Click Confirm Button"
    type: browser.click
    parameters:
      selector: 'button:has-text("Confirm")'
      timeout: 10000

  # ==========================================================================
  # STEP 20: Wait for Gateway Restart
  # ==========================================================================
  - id: step20_wait_for_restart
    name: "Step 20: Wait for Gateway Restart (60 seconds)"
    type: utility.sleep
    parameters:
      seconds: 60

  # ==========================================================================
  # STEP 21: Check if Gateway is Online
  # ==========================================================================
  - id: step21_check_gateway_online
    name: "Step 21: Check if Gateway is Online"
    type: browser.navigate
    parameters:
      url: "{{ parameter.gateway_url }}"
      wait_for: "load"
      timeout: 30
    on_failure: continue

  # ==========================================================================
  # STEP 22: Wait After Restart
  # ==========================================================================
  - id: step22_wait_after_restart
    name: "Step 22: Wait After Restart"
    type: utility.sleep
    parameters:
      seconds: 5
    on_failure: continue

  # ==========================================================================
  # STEP 23: Execution Summary
  # ==========================================================================
  - id: step23_summary
    name: "Step 23: Execution Summary"
    type: utility.python
    parameters:
      script: |
        module_name = """{{ parameter.module_name }}"""
        print("=" * 80)
        print("MODULE UNINSTALLATION SUMMARY")
        print("=" * 80)
        print(f"Module: {module_name}")
        print(f"")
        print(f"Status: Module uninstallation complete")
        print(f"Note: Gateway has been restarted")
        print("=" * 80)
