name: "Backup Gateway"
version: "2.0"
description: "Login to Ignition Gateway and download a configuration backup"

parameters:
  - name: gateway_url
    type: string
    required: true
    description: "Gateway URL (e.g., http://localhost:8088)"

  - name: username
    type: string
    required: true
    description: "Gateway admin username"

  - name: password
    type: string
    required: true
    description: "Gateway admin password"

  - name: download_path
    type: string
    required: false
    default: "./data/downloads"
    description: "Directory where backup file will be saved (default: ./data/downloads)"

steps:
  - id: step1
    name: "Step 1: Execute Gateway Login Playbook"
    type: playbook.run
    parameters:
      playbook: "gateway/gateway_login.yaml"
      gateway_url: "{{ parameter.gateway_url }}"
      username: "{{ parameter.username }}"
      password: "{{ parameter.password }}"
    on_failure: abort

  - id: step2
    name: "Step 2: Navigate to Backup/Restore Page"
    type: browser.navigate
    parameters:
      url: "{{ parameter.gateway_url }}/app/platform/system/backup-restore/backup"
    timeout: 10

  - id: step3
    name: "Step 3: Wait for Backup Page to Load"
    type: browser.wait
    parameters:
      selector: "button, .backup, [class*='download'], [class*='backup']"
    timeout: 10

  - id: step4
    name: "Step 4: Capture Backup Page Screenshot"
    type: browser.screenshot
    parameters:
      path: "backup_page.png"
    timeout: 10

  - id: step5
    name: "Step 5: Click Download Backup Button"
    type: browser.click
    parameters:
      selector: "button:has-text('Download'), button:has-text('Backup'), button[class*='download'], button[class*='backup']"
    timeout: 10
    on_failure: abort

  - id: step6
    name: "Step 6: Wait for Download to Process"
    type: utility.sleep
    parameters:
      seconds: 2
    timeout: 10

  - id: step7
    name: "Step 7: Capture Post-Download Screenshot"
    type: browser.screenshot
    parameters:
      path: "backup_download_complete.png"
    timeout: 10

  - id: step8
    name: "Step 8: Confirm Backup Download Initiated"
    type: utility.log
    parameters:
      message: "Gateway backup download initiated - check downloads directory for .gwbk file"
      level: "info"

metadata:
  author: "Ignition Toolkit"
  category: "gateway"
  tags: ["backup", "maintenance", "configuration"]
